---
title: "Data Visualization in R"
subtitle: "MultiPanel and Layout"
author: "Fushuai Jiang"
date: "`r Sys.Date()`"
output: beamer_presentation

urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  message = FALSE)
knitr::opts_chunk$set(fig.align='center', out.width = "75%")
library(ggplot2)
library(socviz)
library(tidyverse)
library(patchwork)
library(ggcorrplot)
library(corrplot)
library(GGally)
```



## Main functions: `facet_wrap()` and `facet_grid()`

- Reference: chapter 9 and chapter 16 of [ggplot2: Elegant Graphics for Data Analysis](https://ggplot2-book.org/facet.html)


- The `facet_` function allows us to make visually effective multi-grid plots, where each grid displays a different value of the **faceted variable**

- **Benefit:** declutter a busy picture for better comparison

- `facet_Wrap()` splits (facets) on **one variable**

- `facet_grid` splits on multiples (can get pretty busy pretty quickly)



## Main functions: `facet_wrap()` and `facet_grid()`

![](images/08_facet.png)

\tiny From *ggplot2: Elegant Graphics for Data Analysis* 


## Example: `oecd_le`

\tiny
```{r}
library(socviz, ggplot2)
p <- ggplot(oecd_le, aes(x = year, y = lifeexp))
p + geom_line(aes(group = country)) # + labels
```



## `facet_wrap()` example: `oecd_le`

- It makes a long ribbon of panels (determined by `unique(data$var)`)

- `ncol` or `nrow` controls the dimension (only need to specify one of them)

- `dir` contorls the direction of the wrap **h**orizontal or **v**ertical


```{r}
p + facet_wrap(~country)
```


## `facet_wrap()` example: `oecd_le`

```{r}
p + facet_wrap(~country, nrow = 4, dir = "v")
```

## `facet_wrap()` example: `oecd_le`

```{r}
p + facet_wrap(~country, ncol = 7, dir = "h") + 
  geom_line()
```

## `facet_wrap()`: USA vs others

Suppose I want to compare USA vs other countries. How to fix the following plot?

```{r}
p + facet_wrap(~is_usa) + geom_line()
```
## `facet_wrap()`: USA vs others

```{r}
p + facet_wrap(~is_usa) + geom_line(aes(group = country))
```

What else can we do to tell a better story?

## 

```{r}
p2 <- p + facet_wrap(~is_usa) + geom_line(aes(group = country), alpha = 0.4) + 
  geom_smooth(se = F, color= "red", linewidth = 1.7)
p2
```

## Labeling with faceted plots

```{r}
fac.labs <- c(other = "Non-US OECD countries", 
              usa  = "USA")
p2 + facet_wrap(~is_usa, 
                labeller = labeller(is_usa = fac.labs)) + 
labs(title = "Life Expectancy of USA vs non-US OECD countries", x = "Year", y = "Life Expectancy (in years)", caption = "Source: OECD data") + ggthemes::theme_tufte()
```


## Named Character Vectors in `R`

- The `fac.lab` object is a **named character vector** in `R`. These are quite useful for custom labeling

```{r}
fac.labs
typeof(fac.labs)
is.vector(fac.labs)
names(fac.labs)
```


## `facet_Wrap()` example: diamonds

```{r}
ggplot(diamonds, aes(x = clarity, y = price)) + 
  geom_boxplot(aes(color = clarity)) + facet_wrap(~cut) + 
  scale_y_log10(labels = scales::dollar)
```



## `facet_grid`



`facet_grid()` lays out plots in a 2d grid:

- `. ~ var` spreads the values of `var` across the columns
  
- `var ~ .` spreads the values of `var` across the rows
  
- `var1 ~ var2` spreads the values of `var1` across the rows, and `var2` across the columns
  
- The `.` is a placeholder, facilitating the comparison of the corresponding positions
  

## `facet_grid()` on diamonds

```{=latex}
\begin{columns}
\column{0.5\textwidth}
```

```{r, out.width="100%"}
ggplot(diamonds) + 
  facet_grid(. ~ cut)
```

```{=latex}
\column{0.5\textwidth}
```

```{r, out.width="100%"}
ggplot(diamonds) + 
  facet_grid(clarity ~ .)
```

```{=latex}
\end{columns}
```






## `facet_grid()` on diamonds

```{r, message=F, warning = F}
ggplot(dplyr::slice_sample(diamonds, n = 5000)) + 
  facet_grid(clarity ~ cut) + 
  geom_point(aes(x = carat, y = price), size = 0.6, alpha = 0.4) + 
  geom_smooth(aes(x = carat, y = price), se = F)
```




## `facet_grid()` on `mpg`, labeling

```{r}
str(mpg)
```
## Exercise: `facet_grid()` on `mpg`



- Suppose we want to visualize the relationship between the engine displacement (`displ`) and the highway fuel efficiency (`mpg`), 
- categorized by drive train (`drv`) and the types of car (`class`), 
- and use colors to distinguish years.


## `facet_grid()` on `mpg`

```{r}
p <- ggplot(mpg, aes(x=displ, y = hwy))+ 
  geom_point(aes(color = as.factor(year))) + 
  facet_grid(class~drv)
p
```




## `facet_grid()` on `mpg`, LABELING


```{r}
unique(mpg$drv)
unique(mpg$class)
```

```{r}
r_labs <- c("4" = "Four Wheel Drive", 
            "f"= "Front Wheel Drive", 
            "r" = "Rear Wheel Drive")
c_labs <- c('2seater' ="Two seater", 
'compact'="Compact", 'midsize'="Mid-size", 
'minivan'="Minivan", 'pickup'="Pickup truck", 
'subcompact'="Subcompact", 'suv'="Suv")
```




## `facet_grid()` on `mpg`, LABELING

```{r}
p + facet_grid(drv~class,labeller = labeller(
  drv = r_labs, class = c_labs))
```




## Axial scaling


In `facet_`, you can control  if position scales are the same in all panels (`fixed`) or allowed to vary between panels (`free`) with the scales parameter

- `scales = "fixed"`: both x and y scales are fixed

- `scales = "free_x"` or `"free_y"`: free one, fix the other

- `scales = "free"`: both free

- **Why fixed?** -- easier to see patterns across panels

- **Why free?** -- easier to see patterns within panels


## Default: fixed scales

```{r}
p + geom_abline(intercept = c(0,0), slope =10)
# a reference line with intercept at the origin 
# and slope 10, see ?geom_abline
```


## `scales = "free_y"`

```{r}
p + geom_abline(intercept = c(0,0), slope =10) + 
  facet_grid(class~drv, scales = "free_y")
```

## `scales = "free"`

```{r}
p + geom_abline(intercept = c(0,0), slope =10) + 
  facet_grid(class~drv, scales = "free")
```





## When free scaling matters

```{r}
?economics_long
str(economics_long)
unique(economics_long$variable)
```


## When free scaling matters

```{r}
ggplot(economics_long, aes(date, value)) + geom_line() + 
  facet_wrap(~variable, ncol=1)
```





## When free scaling matters

```{r}
ggplot(economics_long, aes(date, value)) + geom_line() + 
  facet_wrap(~variable, ncol=1, scales = "free_y")
```











