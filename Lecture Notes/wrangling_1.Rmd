---
title: "Data Visualization in R"
subtitle: "Data Transformation"
author: "Fushuai Jiang"
date: "`r Sys.Date()`"
output: beamer_presentation

urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align='center', out.width = "85%")

library(tidyverse)
```



## Tidy data (for data frames and tibble)

- Recall **tidy data:** one variable per column, one observation per row, one value per cell

- We have seen: `subset()`, `$`, `[num1, num2]`. Today we will systematically introduce data manipulation using `dplyr`, developed by Hadley Wickham of RStudio

- Advantage: abstract grammar (verbs) for data manipulation that others can read! Also **very fast** as many key functions are coded in `C++`.

- Based on Chapter 3 of Wickham's *R for Data Science*



## Key Functions

- `filter`: subset observations (row) based on given criteria

- `arrange`: reorder observations (row)

**---------------------**

- `select`: return a subset of the variables (columns)

- `rename`: rename variables (columns)

- `mutate`: add new variables (columns)

**--------------------**

- `summarize`: generate statistical summaries from existing variables

- `%>%` or `|>`:  connection multiple verbs



## `nycflights13`


```{r}
library(nycflights13)
library(tidyverse)
slice_sample(flights, n = 5)
```

## `nycflights13`

```{r}
str(flights)
```



# Row operations

## `filter()`

`filter`: subset observations (row) based on given criteria

```{r}
filter(flights, month == 12, day == 14)
```

## `filter()`


```{r}
head(filter(flights, 
            month == 12, day == 14 & dep_delay > 30))
```

\normalsize
- The criteria: December **and** 14th **and** departure delay more than 30 minutes


## Logical structure

Boolean operations: 

- AND: `&` or `,`
- OR: `|`
- NOT: `!`

**-----------**

- EQUALS to: `==`, Greater than: `>`, Less than `<`, along with `>=` and `<=`
- BELONGS to: `%in%`


**-----------**

- **Example:** `(!(x|y))&z =` \pause `!x & !y & z`
- **Example:** `var %in% c(a,b)` is the same as \pause `var == a | var == b`


## `filter()` 

```{r}
NovDec <- filter(flights, month %in% c(11,12))
table(NovDec$month)
```
\pause
- `filter()` returns a `T` or `F` for each part of the expression

- Missing data (`NA`'s) could be a bit tricky

- To keep the `NA` data, add `is.na()` (another Boolean) into `filter`

\tiny 
```{r}
NovDec <- filter(flights, (is.na(month) | month == 11 | month == 12))
table(NovDec$month)
```
\normalsize

- No missing month here! `sum(is.na(flights$month))` to double check



## `arrange()`

- Reorders the row for easier viewing
- If you provide more than one column to order the data by, the additional columns are used to break ties.  
- `NA`s are always sorted to the end
- Default: ascending. Use `desc(var_name)` for descending

##

```{r}
head(arrange(flights, dep_time, carrier), 3)
```



```{r}
head(arrange(flights, desc(dep_time), carrier), 3)
```


# Column Operations

## `select()`

Allows us to pick variables (columns) by name/order to zoom in on useful variables

```{r}
carrier_delay <- select(flights, dep_delay, arr_delay, carrier)
head(carrier_delay, 4)
```


## Use `select()` to delete columns

By putting a minus `-` in front of the list of variables 


```{r}
head(select(flights, -c(year:day)), 4)
```

## Helpers of `select()`


- `starts_with("letters")`
- `ends_with("letters")`
- `contains("letters)`
- `num_Range("x", 1:3)` matches `x1`, `x2`, `x3`


## Example with `contains()`

```{r}
head(select(flights, contains("time")), 3)
head(select(flights, -contains("time")), 3)
```

## Example with `num_range()`

It's useful when variable names are enumerated. 



```{r}
df <- data.frame(id = 1:5, 
                 mt_1 = rnorm(5,0,1),mt_2 = rnorm(5,0,1),
                 mt_3 = rnorm(5,0,1), mt_4 =rnorm(5,0,1))
head(df, 2)
select(df, num_range("mt_", 2:3))
```

## 

**Exercise:** construct a new dataset called `flights_red` that contains all the delay information, along with the distance traveled, in-air time, and the airline information

\pause

```{r}
flights_red <- select(flights,
                      contains("delay"),
                      distance, air_time, carrier)
head(flights_red)
```


## Use `select()` to reorder columns

- You can move the selected variables to the front by inserting `everything()` into `select()`

```{r}
head(select(flights_red, carrier, everything()))
```



## `rename()`

- Syntax: `rename(<data>, new_name = old_name)`


```{r}
head(rename(flights_red, distance_traveled = distance))
```



## `mutate()`

Allows you to create new variables from existing variables. **Key for further investigation!!**

```{r}
mutate(flights_red,
       gain = arr_delay - dep_delay,
       speed = distance / (air_time/60),
       gain_per_hour = gain/(air_time/60))
```



## `mutate()`

Move the new variables to the front by composing the verbs and select 3 random observations. 

```{r}
slice_sample(select(mutate(flights_red,
       gain = arr_delay - dep_delay,
       speed = distance / (air_time/60),
       gain_per_hour = gain/(air_time/60)),
       gain, speed, gain_per_hour, everything()), n = 3)
```


- \textcolor{red}{Pretty hard to read to code, but we will fix this in a bit!}


## `transmute()` a cousin of `mutate()`

But it only keeps the new variables

```{r}
transmute(flights_red,
          gain = arr_delay - dep_delay,
       speed = distance / (air_time/60),
       gain_per_hour = gain/(air_time/60))
```


## `transmute()`

You can save old variables by including them in `transmute()`

```{r}
head(transmute(flights_red,
          gain = arr_delay - dep_delay,
          speed = distance / (air_time/60),
          gain_per_hour = gain/(air_time/60),
          carrier)) # We don't have to re-define carrier. 
```


# Other Functional Operations


## `summarize()` 

It collapses the data frame into a single row

```{r}
flights2 <- mutate(flights_red, 
                   gain = arr_delay - dep_delay, 
                   speed = distance / (air_time/60),
                   gain_per_hour = gain/(air_time/60))
summarize(flights2,
          avg_gain = mean(gain, na.rm = T),
          med_speed = median(speed, na.rm = T))
```

## `summarize()`

- The number of columns depend on the number of statistical quantities you defined.

- Previous example: average again and median speed, so `1 x 2`

- The `na.rm = T` tells you to remove missing data. What if we don't?

```{r}
summarize(flights2,
          avg_gain = mean(gain, na.rm = F))
```

## `summarize()` with groups

More precisely, `summarize` collapses the data frame into a single row **at the group level!** (which is usually what we want)

```{r}
flights3 <- group_by(flights_red, carrier)
summarize(flights3, avg_delay = mean(dep_delay, na.rm = T))
```

## `summarize()` with groups

What if there are multiple grouping criteria?

```{r}
flights3 <- group_by(flights, carrier, month)
summarize(flights3, avg_delay = mean(dep_delay, na.rm = T))
```



## `summarize()` with groups

Let's look at some random samples. What is going on with the dimension here??

```{r}
flights3 <- group_by(flights, carrier, month)
slice_sample(
  summarize(flights3, avg_delay = mean(dep_delay, na.rm = T)),
  n = 4)
```


## Intricacies about Grouping

- After summarizing, you get **one row per group** (by `carrier` and `month`)

- There are `length(unique(flights$carrier)) = 16` carriers and 12 months, so total 192 rows. 
  - If the input is **grouped**, then `slice_sample()` samples within each group
  - By default, `summarize()` drops one level of grouping (`R` message: `summarise()` has grouped output by 'carrier'. You can override using
the `.groups` argument.), so the remaining dataset is still grouped by `carrier`
  - `slice_sample()` picks 4 observations per carrier
  
  

## `summarize()`, dropping all the groups


```{r}
flights3 <- group_by(flights, carrier, month)
slice_sample(
  summarize(flights3, 
            avg_delay = mean(dep_delay, na.rm = T),
            .groups = "drop"),
  n = 4)
```


## `summarie()`, regroup by months

```{r}
flights3 <- group_by(flights, carrier, month)
slice_sample(
  group_by(summarize(flights3, 
                      avg_delay = mean(dep_delay, na.rm = T),
                      .group = "drop"),
           month),
  n = 2)
```


# The pipeline

## The pipeline `|>`

The function in the last slide was hard to read, so we (always from now on) use the pipeline

```{r}
flights |>
  group_by(carrier,month) |>
  summarize(avg_delay = mean(dep_delay, na.rm = T),
            .group = "drop") |>
  group_by(month) |>
  head(2)
```


## What is the pipeline doing?

- A pipeline always **STARTS WITH THE DATA**
- It looks like
```
data |> f_1() |> f_2()
```
- It means that the **OUTPUT** of `f_1` is fed into the first input of `f_2()` (which again is always the data!)

- It is equivalent to the composition
```
f_2( f_1( data , ...), ...)
```

## The pipeline `|>`

Consider the example from before:
\small
```{r, eval = F}
slice_sample(select(mutate(flights_red,
                            gain = arr_delay - dep_delay,
                            speed = distance / (air_time/60),
                            gain_per_hour = gain/(air_time/60)),
                      everything()), 
              n = 3)
```
\normalsize
How to change it into a single pipeline? \pause

```{r}
flights_red |>
  mutate(gain = arr_delay - dep_delay,
         speed = distance / (air_time/60),
         gain_per_hour = gain/(air_time/60)) |>
  select(gain, speed, gain_per_hour, everything()) |>
  slice_sample(n = 3)
```


## Difference `|>` VS `%>%`

More can be found in the [tidyverse.org](https://www.tidyverse.org/blog/2023/04/base-vs-magrittr-pipe/)

- `%>%` is provided by the `dplyr` package, and `|>` comes from the base `R` 

- They are mostly equivalent within the scope of this class, and I will mostly use `|>`

- `%>%` is more advanced. For example, it can pipe into multiple entries, and it requires the period `.` as a placeholder. `df %>% {cor(.$x, .$y)}` is the same as `cor(df$x, df$y)`

- `|>` pipes into the first unnamed argument, unless you use `_` as a placeholder (`R 4.2`)



## Joining datasets (Assignment 3, Exercise 3)

```{r, eval = F}
?join
```

![](images/wrangling_join.png)
\tiny\flushright Source: statisticsglobe.com



