---
title: "Data Visualization in R"
subtitle: "Data Transformation"
author: "Fushuai Jiang"
date: "`r Sys.Date()`"
output: beamer_presentation

urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align='center', out.width = "85%")

library(tidyverse)
```



## Tidy data (for data frames and tibble)

- Recall **tidy data:** one variable per column, one observation per row, one value per cell

- We have seen: `subset()`, `$`, `[num1, num2]`. Today we will systematically introduce data manipulation using `dplyr`, developed by Hadley Wickham of RStudio

- Advantage: abstract grammar (verbs) for data manipulation that others can read! Also **very fast** as many key functions are coded in `C++`.

- Based on Chapter 3 of Wickham's *R for Data Science*



## Key Functions

- `filter`: subset observations (row) based on given criteria

- `arrange`: reorder observations (row)

**---------------------**

- `select`: return a subset of the variables (columns)

- `rename`: rename variables (columns)

- `mutate`: add new variables (columns)

**--------------------**

- `summarize`: generate statistical summaries from existing variables

- `%>%` or `|>`:  connection multiple verbs



## `nycflights13`


```{r}
library(nycflights13)
library(tidyverse)
slice_sample(flights, n = 5)
```

## `nycflights13`

```{r}
str(flights)
```



# Row operations

## `filter()`

`filter`: subset observations (row) based on given criteria

```{r}
filter(flights, month == 12, day == 14)
```

## `filter()`

\tiny
```{r}
head(filter(flights, month == 12, day == 14 & dep_delay > 30))
```

\normalsize
- The criteria: December **and** 14th **and** departure delay more than 30 minutes


## Logical structure

Boolean operations: 

- AND: `&` or `,`
- OR: `|`
- NOT: `!`

**-----------**

- EQUALS to: `==`, Greater than: `>`, Less than `<`, along with `>=` and `<=`
- BELONGS to: `%in%`


**-----------**

- **Example:** `(!(x|y))&z =` \pause `!x & !y & z`
- **Example:** `var %in% c(a,b)` is the same as \pause `var == a | var == b`


## `filter()` 

```{r}
NovDec <- filter(flights, month %in% c(11,12))
table(NovDec$month)
```
\pause
- `filter()` returns a `T` or `F` for each part of the expression

- Missing data (`NA`'s) could be a bit tricky

- To keep the `NA` data, add `is.na()` (another Boolean) into `filter`

\tiny 
```{r}
NovDec <- filter(flights, (is.na(month) | month == 11 | month == 12))
table(NovDec$month)
```
\normalsize

- No missing month here! `sum(is.na(flights$month))` to double check



## `arrange()`

- Reorders the row for easier viewing
- If you provide more than one column to order the data by, the additional columns are used to break ties.  
- `NA`s are always sorted to the end
- Default: ascending. Use `desc(var_name)` for descending

##

```{r}
head(arrange(flights, dep_time, carrier))
```



```{r}
head(arrange(flights, desc(dep_time), carrier))
```


# Column Operations

## `select()`

Allows us to pick variables (columns) by name/order to zoom in on useful variables

```{r}
carrier_delay <- select(flights, dep_delay, arr_delay, carrier)
carrier_delay
```


## Use `select()` to delete columns

By putting a minus `-` in front of the list of variables 


```{r}
head(select(flights, -c(year:day)))
```

## Helpers of `select()`


- `starts_with("letters")`
- `ends_with("letters")`
- `contains("letters)`
- `num_Range("x", 1:3)` matches `x1`, `x2`, `x3`


## Example with `contains()`

```{r}
head(select(flights, contains("time")))
head(select(flights, -contains("time")))
```

## Example with `num_range()`

It's useful when variable names are enumerated. 



```{r}
df <- data.frame(id = 1:5, mt_1 = rnorm(5,0,1),mt_2 = rnorm(5,0,1),
                 mt_3 = rnorm(5,0,1), mt_4 = rnorm(5,0,1))
head(df)
select(df, num_range("mt_", 2:3))
```


