---
title: "Data Visualization in R"
subtitle: "Multiple `geom_`"
author: "Fushuai Jiang"
date: "`r Sys.Date()`"
output: beamer_presentation

urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align='center', out.width = "85%")
library(gapminder)
library(ggplot2)
library(socviz)
library(tidyverse)
```




## Collective `geoms`

- **individual** `geom_()` draws a distinct graphical object for each observation 

- **collective** `geom_()` display multiple observations with one geometric object.

- KEY: the `group` aesthetic

- By default, the `group` aesthetic is mapoed to the interaction of all discrete variables in the plot

- We will often need to *explicitly* define the grouping structure





## Example: `mpg`

```{r}
ggplot(mpg, aes(x = displ, y = hwy)) + 
  geom_point() + geom_line()
```




## Example: `mpg`

```{r}
ggplot(mpg, aes(x = displ, y = hwy)) + 
  geom_point() + geom_smooth()
```


## Example: `mpg`

```{r, out.width = "75%"}
ggplot(mpg, aes(x = displ, y = hwy)) + 
  geom_point() + geom_smooth(aes(group = drv))
```

- After specifying the `group` aesthetics, `geom_smooth()` knows to compute a smoothing model for each group. 



## Example: `mpg`

With a little bit of work, you can start showing off at a party

\small
```{r}
drvtype = c("4-wheel", "Front-wheel", "Rear-wheel")
coltype = c("purple", "blue", "forestgreen")
p <- ggplot(mpg, aes(x = displ, y = hwy)) + 
  ggthemes::theme_tufte() + 
  geom_point() + 
  geom_smooth(aes(color = drv, fill = drv)) + 
  labs(
    x = "Engine displacement (L)",
    y = "Highway MPG", color = "Drive type",
    title = "MPG vs Engine displacement for various drive types") + 
  scale_color_manual(labels = drvtype, values = coltype) + 
  scale_fill_manual(labels = drvtype, values = coltype) + 
  guides(fill = "none")
```


##

```{r, echo = F}
p
```


## Example: `Oxboys`

Be careful about where grouping occurs!

```{r}
# A different way to load a dataset from a package
data(Oxboys, package = "nlme")
head(Oxboys)
```


## Example: `Oxboys`

```{r}
ggplot(Oxboys, 
       aes(x = age, y = height, group = Subject)) + 
  geom_line()
```


## Example: `Oxboys`

- Say I want to figure out the over height trend across all subjects. 

\tiny
```{r, out.width="65%"}
ggplot(Oxboys, 
       aes(x = age, y = height, group = Subject)) + 
  geom_line() + geom_smooth(method = "lm", se = F)
```
\normalsize
- Note that this gives us many smoothing lines, one for each subject. Why? \pause Because `group` was specified globally (in `ggplot()`) 


## Example: `Oxboys`

To fix this, we move the global `group` assignment into `geom_line()`.

\tiny
```{r, out.width="65%"}
ggplot(Oxboys, 
       aes(x = age, y = height)) + 
  geom_line(aes(group = Subject)) +
  geom_smooth(method = "lm", se = F, size = 4, color = "red")
```

## Boxplots with `geom_boxplot`

```{r}
ggplot(Oxboys, aes(Occasion, height)) + geom_boxplot()
```

## How to read a boxplot

![Component of a Boxplot](images/06_boxplot_explain.png)

## Digression: Robust Statistics


- **Robust statistics** maintain their properties even if the underlying distributional assumptions are incorrect (not significantly affected by outliers or small contamination)

- Non-examples: mean, standard deviation

- Examples: median, interquartile range

\tiny

```{r}
set.seed(2025)
x <- rnorm(100, 0, 1)
x_extreme <- c(x, 10000000)
mean(x_extreme) - mean(x)
median(x_extreme) - median(x)
sd(x_extreme) - sd(x)
IQR(x_extreme) - IQR(x)
```

## Boxplots with `gapminder`

**Exercise:** For the `gapminder` dataset, create a boxplot with five boxes, one for each continent. Lay out the continents along the $x$-axis, and the $y$-axis corresponds to the life expectancy, distinguish continents by `fill`. Fix labels and legends. 

\pause
```{r}
p <- ggplot(gapminder, 
            aes(x = continent, y = lifeExp, fill = continent)) + 
  geom_boxplot() + ggthemes::theme_pander() + 
  labs(
    x = "Continent", y = "Life Expectancy", fill = "Continent", 
    title = "Life expectancy of each continent", caption = "Source: gapminder"
  )
```


## Boxplots with `gapminder`

You can be a bit fancy here and choose a different color scheme, for instance, `viridis`. 

```{r, echo = T}
library(viridis)
p + scale_fill_viridis(discrete = T, alpha = 0.5)
```

## From the `beyonce` package

- Overwhelmed by the choice of colors? Here's more using the `paletteer` package: <https://r-graph-gallery.com/color-palette-finder>

\tiny

```{r, out.width="60%"}
library(paletteer)
p + scale_fill_paletteer_d("beyonce::X128", direction = -1)
```
\normalsize

- Note that the syntax is `<PackageName::PaletteName>`. You can type in `View(paletteer::palettes_d_names)` to see the package/palette names. 

## From the `fishualize` package

\tiny

```{r}
p + scale_fill_paletteer_d("fishualize::Hypsoblennius_invemar", direction = -1)
```

## Boxplots + Scatterplots

```{r}
p + scale_fill_paletteer_d("lisa::JackBush") + 
  geom_jitter(color = "black", alpha = 0.2, size = 0.4) + 
  coord_flip()
```
## `geom_point()` vs `geom_jitter()`

```{r, out.width="50%"}
p + scale_fill_paletteer_d("lisa::JackBush_1") + 
  geom_point(color = "black", alpha = 0.2, size = 0.4) + 
  coord_flip()
```
- The plot above uses `geom_point` instead, and all the points lie on the corresponding axes (overcrowded/overplotting)
- `geom_jitter` adds a small amount of noise to data to spread them out for better visualization


## Visualizing distribution using `geom_violin()`

```{r. out.width= "65%"}
pvio <- ggplot(gapminder, aes(x = continent, y = lifeExp, fill = continent)) + 
  geom_violin(trim = F) + 
  ggthemes::theme_economist_white() + scale_fill_paletteer_d("lisa::JackBush")
pvio
```
Note that `geom_violin` does not automatically produce the quantiles like boxplots. For this, you need to couple with `stat_summary`

## A glimpse into `stat_summary`

\tiny
```{r, out.width="65%"}
pvio + 
  stat_summary(fun = median, geom = "point", size = 3,show.legend = FALSE )+
  stat_summary(fun.data = function(y) {return(data.frame(
        y = median(y), ymin = quantile(y, 0.25), ymax = quantile(y, 0.75)))}, 
              geom = "errorbar", width = 0.1)
```
- `stat_summary()` is a very flexible function that allows you to overlay summary statistics on raw data plots. More on this later. 






