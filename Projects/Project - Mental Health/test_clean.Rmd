---
title: "R Notebook"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE)
library(tidycensus)
library(tidyverse)
library(ggplot2)
library(readr)
library(maps)
library(tigris)
library(sf)
library(viridis)
library(paletteer)

# Census API: 12356c4c0007681b582c5dbc170870776edb27b5
# To activate:
# census_api_key("12356c4c0007681b582c5dbc170870776edb27b5", install = TRUE)
```


## Loading and cleaning the CDC data


```{r load and clean cdc data}

# variables to select
cdc_vars <- c("State", "County", "Year", "Value", "Confidence Interval Low", "Confidence Interval High")
# common renaming
cdc_vars_rename <- c(
  "state" = "State",
  "county" = "County", 
  "year" = "Year", 
  "est" = "Value", 
  "lci" = "Confidence Interval Low",
  "uci" = "Confidence Interval High")

# depression data cleaning
# note that all confidence interval values were previous stored as characters
depr_cdc <- read_csv("data/cdc_depression_adjusted.csv") |> 
  select(all_of(cdc_vars)) |>
  rename(cdc_vars_rename) |> 
  mutate(
    across(c("est", "lci", "uci"),
                ~ as.numeric(sub("%", "",.))))

# distress data, need to remove 2018
dist_cdc <- read_csv("data/cdc_mental_distress_adjusted.csv") |> 
  select(all_of(cdc_vars)) |>
  rename(cdc_vars_rename) |> 
  filter(! year == 2018) |> 
  mutate(
    across(c("est", "lci", "uci"),
                ~ as.numeric(sub("%", "",.))))

# merge
cdc <- inner_join(
  depr_cdc, dist_cdc,
  by = c("state", "county", "year"),
  suffix = c("_depr", "_dist"))

# remove extra objects
rm(dist_cdc, depr_cdc, cdc_vars, cdc_vars_rename)

glimpse(cdc)
```


## Loading map data from `tidycensus`


My personal Census API key: `12356c4c0007681b582c5dbc170870776edb27b5`. To activate, run `census_api_key("12356c4c0007681b582c5dbc170870776edb27b5", install = TRUE)`. We can view the variables by using `load_variables()` function. See `?load_variables` for more.

```{r loading census map ACS 2020}
# loading a sample map data 
# from ACS 2020
counties <- get_acs(
  geography = "county",
  variables = "B19013_001",
  year = 2020,
  geometry = TRUE) |>
  separate_wider_delim(NAME,
                       delim = ", ",
                       names = c("county", "state")) |> 
  mutate(
    county = gsub(" County$", "", county),
    state = trimws(state)) |> 
  select(-c("variable", "estimate", "moe"))

glimpse(counties)
```

## Merging Census map with CDC data and geospatial plots

```{r merging census with cdc}
cdc_map <- left_join(cdc, counties, by = c("state", "county"))
# the geometry column is not sf so convert
cdc_map <- st_as_sf(cdc_map)
# glimpse(cdc_map)
```
We take a look at the plot in the DMV area

```{r plotting depression in the dmv area}
state_list <- c("Maryland", "District of Columbia", "Virginia")
cdc_map |> 
  filter(state %in% state_list) |> 
  ggplot() + geom_sf(aes(fill = est_depr), color = NA) + 
  coord_sf() + 
  scale_fill_viridis_c(option = "magma", direction = -1) + 
  ggthemes::theme_map() + 
  labs(title = "Prevalence of Depression in the DMV Area",
       fill = "Prevalence (in %)", 
       caption = "Source: CDC data overlayed with 2020 ACS Census")
rm(state_list)
```


Visualizing the changes over the course of 3 years.

```{r plotting depression in the dmv area 3 years, fig.width=12, fig.height=18}
state_list <- c("Maryland", "District of Columbia", "Virginia")
cdc_map |> 
  filter(state %in% state_list) |> 
  ggplot() + geom_sf(aes(fill = est_depr), color = NA) + 
  coord_sf() + 
  scale_fill_viridis_c(option = "magma", direction = -1) + 
  ggthemes::theme_map() + 
  facet_wrap(~year, ncol = 1) +
  theme(
    legend.position = "bottom"
  ) + 
  labs(title = "Prevalence of Depression in the DMV Area",
       fill = "Prevalence (in %)", 
       caption = "Source: CDC data overlayed with 2020 ACS Census")
rm(state_list)
```

## Variable selection from Census

First we load all the variable names + explanations from the 2020 ACS.

```{r}
v20 <- load_variables(2020, "acs5", cache = TRUE)
```


```{r}
key_vars <- v20 |>
  mutate(
    table = str_extract(name, "^[A-Za-z0-9]+"),     # e.g. "B01001"
    label2 = str_squish(label),
    concept2 = str_squish(concept))

# Quick: list the most frequent concepts (so you can see what to pick)
key_vars_freq <- key_vars |>
  count(concept2, sort = TRUE) |>
  slice_head(n = 50) 
```


```{r}
library(dplyr)
library(stringr)

# Step 0: take your census_var tibble
# census_var has columns: name, label, concept

census_var2 <- v20 %>%
  mutate(
    table = str_extract(name, "^[A-Za-z0-9]+"),     # e.g. "B01001"
    label2 = str_squish(label),
    concept2 = str_squish(concept)
  )

# Quick: list the most frequent concepts (so you can see what to pick)
census_var2 %>%
  count(concept2, sort = TRUE) %>%
  slice_head(n = 50) %>%
  print(n = 50)

```



```{r}
# domain keywords to search in the concept (careful, keep them conservative)
domains <- list(
  age_sex      = "SEX BY AGE|SEX BY AGE (|AGE BY SEX|AGE",
  education    = "EDUCATIONAL ATTAINMENT|EDUCATION ATTAINMENT",
  income       = "MEDIAN HOUSEHOLD INCOME|MEDIAN INCOME|INCOME",
  employment   = "EMPLOYMENT|EMPLOYMENT STATUS|LABOR FORCE|UNEMPLOYED",
  poverty      = "POVERTY STATUS|POVERTY",
  race         = "\\bRACE\\b|HISPANIC|HISPANIC ORIGIN",
  housing      = "HOUSING|TENURE|HEATING|PLUMBING|AIR CONDITIONING|VEHICLES",
  disability   = "DISABILITY|DISABLED"
)

filter_by_domain <- function(df, keyword_regex) {
  df %>%
    filter(
      str_detect(concept2, regex(keyword_regex, ignore_case = TRUE)) |
      str_detect(label2,   regex(keyword_regex, ignore_case = TRUE))
    )
}

# Example: get compact lists
vars_age_sex    <- filter_by_domain(census_var2, domains$age_sex)
vars_education  <- filter_by_domain(census_var2, domains$education)
vars_income     <- filter_by_domain(census_var2, domains$income)
vars_employment <- filter_by_domain(census_var2, domains$employment)
vars_poverty    <- filter_by_domain(census_var2, domains$poverty)
vars_race       <- filter_by_domain(census_var2, domains$race)
vars_housing    <- filter_by_domain(census_var2, domains$housing)
vars_disability <- filter_by_domain(census_var2, domains$disability)

# See how many variables each produced:
tibble(
  domain = c("age_sex","education","income","employment","poverty","race","housing","disability"),
  n_vars = c(nrow(vars_age_sex), nrow(vars_education), nrow(vars_income), nrow(vars_employment),
             nrow(vars_poverty), nrow(vars_race), nrow(vars_housing), nrow(vars_disability))
)

```


```{r}
# show distinct tables in the age/sex candidate set
vars_age_sex %>% distinct(table, concept2) %>% arrange(table)

# show a few label examples
vars_education %>% distinct(table, label2) %>% slice_head(n = 20)

```



