---
title: "Aggregate Predictors of Mental Health Outcomes"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidycensus)
library(tidyverse)
library(ggplot2)
library(readr)
library(maps)
library(tigris)
library(sf)
library(viridis)
library(paletteer)
```

## Main guiding questions

1. At the province/state level, are mental health outcomes (e.g. prevalence of poor mental health, hospitalizations for mental illness) more strongly associated with demographic composition (e.g. % youth, % female, % older adults) or socioeconomic indicators (median income, % with college degree, unemployment rate)?

2. Do environmental factors (e.g. heat waves, cold spells) appear correlated with changes in population-level mental health outcomes?

3. How do these associations vary over time (e.g. pre/post pandemic or across several years)?



## Data Source

- [CDC Data Explorer](https://ephtracking.cdc.gov/DataExplorer/)
  - Source 1: Age-adjusted prevalence of frequent mental distress among adults (model-based with confidence intervals)
  - Source 2: Age-adjusted Prevalence of Depression Among Adults (model-based with confidence intervals)
  - The methodology for the estimation can be found [here](https://www.cdc.gov/places/methodology/index.html)
- [US Census Data](https://data.census.gov/), integrated using the `tidycensus` [R package](https://walker-data.com/tidycensus/).


## Loading and Cleaning the data

```{r}
depression_og <- read_csv("data/cdc_depression_adjusted.csv")
distress_og <- read_csv("data/cdc_mental_distress_adjusted.csv")
```




```{r depression cleaning}
depression <- depression_og |> 
  rename(
    year = Year,
    LCI_depression = "Confidence Interval Low",
    UCI_depression = "Confidence Interval High", 
    val_depression = Value) |>
  mutate(
    LCI_depression = as.numeric(sub("%", "", LCI_depression)),
    UCI_depression = as.numeric(sub("%", "", UCI_depression)),
    val_depression = as.numeric(sub("%", "", val_depression))) |> 
  filter(year %in% c(2019, 2020, 2021)) |> 
  select(State, County, year, val_depression, LCI_depression, UCI_depression)
# depression$State <- tolower(depression$State)
# depression$County <- tolower(depression$County)
head(depression)
```


```{r distress cleaning}
distress <- distress_og |> 
  rename(
    year = Year,
    LCI_distress = "Confidence Interval Low",
    UCI_distress = "Confidence Interval High", 
    val_distress = Value) |> 
  mutate(
    LCI_distress = as.numeric(sub("%", "", LCI_distress)),
    UCI_distress = as.numeric(sub("%", "", UCI_distress)),
    val_distress = as.numeric(sub("%", "", val_distress))) |> 
  filter(year %in% c(2019, 2020, 2021)) |> 
  select(State, County, year, val_distress, LCI_distress, UCI_distress)
# distress$State <- tolower(distress$State)
# distress$County <- tolower(distress$County)
head(distress)
```




## Initial visualization

```{r loading county map information}
counties_sf <- counties(cb = TRUE, year = 2021)
```


```{r merging depression map}
depression_map <- counties_sf |>
  left_join(depression, by = c("NAME" = "County"))   # adjust join key!
```

```{r filtering contiguous US}
depression_map_ctgs <- depression_map |> 
  filter(!State %in% c("Alaska", "Hawaii")) |> 
  filter(!is.na(State)) |> 
  filter(!STATE_NAME %in% c("United States Virgin Islands", "Puerto Rico"))
# depression_map_ctgs |> pull(State) |> unique()
# depression_map_ctgs |> pull(STATE_NAME) |> unique()
```

```{r separate years}
depression_map_2019 <- depression_map_ctgs |> filter(year == 2019)
depression_map_2020 <- depression_map_ctgs |> filter(year == 2020)
depression_map_2021 <- depression_map_ctgs |> filter(year == 2021)
```

```{r depression 2020, out.width = 24, out.height=18}
plot_depression_2020 <- depression_map_2020 |> 
ggplot() +
  geom_sf(aes(fill = val_depression)) + 
  coord_sf(datum = NA, xlim = c(-125, -66), ylim = c(24, 50)) + 
  ggthemes::theme_map() + 
  scale_fill_viridis_c(option = "magma", name = "Depression Prevalance in %", direction = -1) + 
  theme(legend.position = "bottom")
plot_depression_2020
```

```{r depression 2020 dmv-area}
depression_map_2020 |> filter(STATE_NAME %in% c("Maryland", "Virginia", "District of Columbia")) |> 
ggplot() +
  geom_sf(aes(fill = val_depression)) + 
  coord_sf(datum = NA) + 
  ggthemes::theme_map() + 
  scale_fill_viridis_c(option = "magma", name = "Depression Prevalance (in %)", direction = -1) + 
  labs(title = "Depression Prevalence in the DMV Area", 
       caption = "Data source: CDC")
```



```{r depression by year, fig.width = 24, fig.height=8}
plot_depression_by_year <- depression_map_ctgs |> 
ggplot() +
  geom_sf(aes(fill = val_depression)) + 
  coord_sf(datum = NA, xlim = c(-125, -66), ylim = c(24, 50)) + 
  ggthemes::theme_map() + 
  facet_wrap(~year, ncol = 3) + 
  scale_fill_viridis_c(option = "magma", name = "Depression Prevalance in %") + 
  theme(
    legend.position = "bottom"
  )
plot_depression_by_year
```


```{r}
# ggsave("depression_by_year.png", plot = plot_depression_by_year, width = 24, height = 12, dpi = 300)
```


Now we compute the first and second "derivatives"


```{r}
depression_diff_2020 <- depression_map_2020 |> 
  mutate(
    diff = val_depression - depression_map_2019$val_depression
  ) |> 
  select(-c("val_depression", "LCI_depression", "UCI_depression")) |> 
  select(diff, everything())
# head(depression_diff_2020)


```

There is an issue computing the difference between 2021 and 2020, because the 2020 data has `r length(depression_map_2020$val_depression)` entries, while the 2021 data has `r length(depression_map_2021$val_depression)` entries. To fix this, we create a substitute by `inner_join`-ing the two dataset. 

```{r}
depression_diff_2021 <- depression_map_2021 |>
  inner_join(
    depression_map_2020 |>
      st_drop_geometry() |>                # drop geometry to avoid conflicts
      select(GEOID, val_depression) |>
      rename(val_depression_2020 = val_depression),
    by = "GEOID"
  ) |>
  mutate(
    diff = val_depression - val_depression_2020
  ) |>
  select(diff, everything())
```

Taking a look at the DMV area
```{r dmv area 2021 change}
ggplot(
  subset(depression_diff_2021, 
         STATE_NAME %in% c("Maryland", "Virginia", "District of Columbia"))) + 
  geom_sf(aes(fill = diff), color = "grey") + 
  coord_sf(datum = NA) + 
  ggthemes::theme_map() + 
  scale_fill_gradient2(low = "darkgreen", mid = "white", high = "purple", midpoint = 0)
```



```{r depression improvement in 2020}
depression_diff_2020 |> 
  ggplot() + 
  geom_sf(aes(fill = diff), color = NA) + 
  coord_sf(datum = NA, xlim = c(-125, -66), ylim = c(24, 50)) + 
  ggthemes::theme_map() + 
  scale_fill_gradient2(low = "green", mid = "white", high = "red", midpoint = 0)
```


```{r depression improvement in 2020 DMV area}
depression_diff_2020 |> 
  filter(STATE_NAME %in% c("Maryland", "Virginia", "District of Columbia")) |> 
  ggplot() + 
  geom_sf(aes(fill = diff), color = "grey") + 
  coord_sf(datum = NA) + 
  ggthemes::theme_map() + 
  scale_fill_gradient2(low = "darkgreen", mid = "white", high = "purple", midpoint = 0)
```





