---
title: "Aggregate Predictors of Mental Health Outcomes"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidycensus)
library(tidyverse)
library(ggplot2)
library(readr)
library(maps)
library(tigris)
library(sf)
library(viridis)
library(paletteer)
```

## Main guiding questions

1. At the province/state level, are mental health outcomes (e.g. prevalence of poor mental health, hospitalizations for mental illness) more strongly associated with demographic composition (e.g. % youth, % female, % older adults) or socioeconomic indicators (median income, % with college degree, unemployment rate)?

2. Do environmental factors (e.g. heat waves, cold spells) appear correlated with changes in population-level mental health outcomes?

3. How do these associations vary over time (e.g. pre/post pandemic or across several years)?



## Data Source

- [CDC Data Explorer](https://ephtracking.cdc.gov/DataExplorer/)
  - Source 1: Age-adjusted prevalence of frequent mental distress among adults (model-based with confidence intervals)
  - Source 2: Age-adjusted Prevalence of Depression Among Adults (model-based with confidence intervals)
  - The methodology for the estimation can be found [here](https://www.cdc.gov/places/methodology/index.html)
- [US Census Data](https://data.census.gov/), integrated using the `tidycensus` [R package](https://walker-data.com/tidycensus/).


## Loading and Cleaning the data

```{r}
depression_og <- read_csv("data/cdc_depression_adjusted.csv")
distress_og <- read_csv("data/cdc_mental_distress_adjusted.csv")
```


```{r depression cleaning}
depression <- depression_og |> 
  rename(
    year = Year,
    LCI_depression = "Confidence Interval Low",
    UCI_depression = "Confidence Interval High", 
    val_depression = Value) |>
  mutate(
    LCI_depression = as.numeric(sub("%", "", LCI_depression)),
    UCI_depression = as.numeric(sub("%", "", UCI_depression)),
    val_depression = as.numeric(sub("%", "", val_depression))) |> 
  filter(year %in% c(2019, 2020, 2021)) |> 
  select(State, County, year, val_depression, LCI_depression, UCI_depression)
# depression$State <- tolower(depression$State)
# depression$County <- tolower(depression$County)
head(depression)
```


```{r distress cleaning}
distress <- distress_og |> 
  rename(
    year = Year,
    LCI_distress = "Confidence Interval Low",
    UCI_distress = "Confidence Interval High", 
    val_distress = Value) |> 
  mutate(
    LCI_distress = as.numeric(sub("%", "", LCI_distress)),
    UCI_distress = as.numeric(sub("%", "", UCI_distress)),
    val_distress = as.numeric(sub("%", "", val_distress))) |> 
  filter(year %in% c(2019, 2020, 2021)) |> 
  select(State, County, year, val_distress, LCI_distress, UCI_distress)
# distress$State <- tolower(distress$State)
# distress$County <- tolower(distress$County)
head(distress)
```




## Initial visualization

```{r loading county map information}
counties_sf <- counties(cb = TRUE, year = 2021)
```


```{r merging depression map}
depression_map <- counties_sf |>
  left_join(depression, by = c("NAME" = "County"))   # adjust join key!
```

```{r}
depression_map_ctgs <- depression_map |> 
  filter(!State %in% c("Alaska", "Hawaii")) |> 
  filter(!is.na(State)) |> 
  filter(!STATE_NAME %in% c("United States Virgin Islands", "Puerto Rico"))
depression_map_ctgs |> pull(State) |> unique()
depression_map_ctgs |> pull(STATE_NAME) |> unique()
```



```{r depression by year, fig.width = 24, fig.height=8}
plot_depression_by_year <- depression_map_ctgs |> 
ggplot() +
  geom_sf(aes(fill = val_depression)) + 
  coord_sf(datum = NA, xlim = c(-125, -66), ylim = c(24, 50)) + 
  ggthemes::theme_map() + 
  facet_wrap(~year, ncol = 3) + 
  scale_fill_viridis_c(option = "magma", name = "Depression Prevalance in %") + 
  theme(
    legend.position = "bottom"
  )
plot_depression_by_year
```


```{r}
ggsave("depression_by_year.png", plot = plot_depression_by_year, width = 24, height = 12, dpi = 300)
```


Now we compute the first and second "derivatives"

```{r}
dep_val_19 <- depression_map_ctgs |> filter(year == 2019) |> pull(val_depression)
dep_val_20 <- depression_map_ctgs |> filter(year == 2020) |> pull(val_depression)
dep_val_21 <- depression_map_ctgs |> filter(year == 2021) |> pull(val_depression)
```






